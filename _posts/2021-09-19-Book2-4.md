---
title: "빅데이터를 지탱하는 기술(4) - 빅데이터의 축적"
excerpt: ""

categories:
  - Book
  - Data Engineering
tags:
  - Book
  - Data Engineering 기초
toc: true
toc_label: "목차"
published: false
---

# 4. 빅데이터의 축적

## 4.1 벌크 형과 스트리밍 형의 데이터 수집

### 객체 스토리지와 데이터 수집

빅데이터는 대부분 확정성이 높은 분산 스토리지에 저장된다. 데이터베이스가 이용되는 경우도 있지만, 기본적으로 객체 스토리지에 저장한다. HDFS, Amazon S3 등이 유명하다.

※ 스토리지와 데이터베이스의 차이

스토리지는 파일 형태가 되면 무엇이든 담을 수 있다. DB는 서버를 통해 가공된 데이터가 담긴다. 게시판에서 글은 DB에 담기고, 업로드한 파일은 스토리지에 담긴다. 스토리지에 저장된 데이터를 더욱 사용하기 쉽게 만들어주는 것이 데이터베이스라고 할 수 있다.

이러한 객체 스토리지는 작은 데이터에는 오히려 비효율적이다. 네트워크를 거쳐 실행하기 때문에 데이터양에 비해 통신 오버헤드가 너무 크기 때문이다.

#### 데이터 수집

객체 스토리지는 대량의 작은 파일을 저장하면 성능을 저하시키는 요인이 된다. 따라서 작은 데이터는 적당히 모아서 하나의 큰 파일로 만듦으로서 효율을 높이는 데 도움이 된다.

그것과 반대로 파일이 지나치게 커도 안된다. 파일 크기가 증가하면 네트워크 전송에 시간이 걸려 예상치 못한 오류 발생률을 높인다. 이러한 데이터는 적당히 나눔으로써 문제 발생을 줄일 수 있다.

객체 스토리지에서 효율적으로 처리할 수 있는 파일 크기는 대략 1MB에서 1GB이다.

수집한 데이터를 가공해서 집계 효율이 좋은 분산 스토리지를 만드는 일련의 프로세스를 데이터 수집이라고 한다. 여기에는 데이터 수집부터 구조화 데이터의 작성, 분산 스토리지에 대한 장기적인 저장 등이 포함된다.

### 벌크 형의 데이터 전송

전통적인 데이터 웨어하우스에서 사용된 것이 주로 벌크 형 방식으로 DB나 파일 서버 또는 웹 서비스 등에서 SQL, API로 정리해 데이터를 추출한다.

데이터가 처음부터 분산 스토리지에 저장되어 있는 것이 아니라면 데이터 전송을 위한 **ETL 서버**를 설치해야 한다.

<img src="https://drive.google.com/uc?export=view&id=1W8eHnC2Et5NjR4THayuEZEYzgc3sr_Pb">

#### 파일 사이즈 적정화

벌크 형 도구로 파일 사이즈를 적정화하는 것은 비교적 간단하다. 데이터를 너무 자주 전송하고 있다면 한 번의 전송에 모든 파일을 포함하도록 변경하고, 또 너무 많은 양의 데이터를 한꺼번에 전송한다면 작은 태스크로 분해해 한 번의 태스크 실행이 커지지 않도록 조정한다. 이러한 작업은 워크플로 관리 도구를 사용해 쉽게 관리할 수 있다.

#### 데이터 전송의 워크플로

데이터 전송의 신뢰성이 중요한 경우에는 가능한 벌크 형 도구를 사용해야 한다. 벌크 형은 워크플로 관리 도구와의 궁합이 뛰어나다.

### 스트리밍 형의 데이터 전송

<img src="https://drive.google.com/uc?export=view&id=1lcIIuBa5e5d22CenQXhVz3l6kB3OcdzQ">

스트리밍 형 데이터 전송의 특징은 다수의 클라이언트에서 계속해서 작은 데이터가 전송되는 것이다. 이러한 전송 방식을 일반적으로 메시지 전송이라고 한다. 이는 데이터양에 비해 통신을 위한 오버헤드가 커지기 때문에 이를 처리하는 서버는 높은 성능을 요구한다.

메시지를 저장하는 데에는 여러 방법이 있다. 그 중 하나는 작은 데이터 쓰기에 적합한 NoSQL을 이용하는 것이다. 이 경우 Hive와 같은 쿼리 엔진으로 연결해 데이터를 읽을 수 있다.

또는 분산 스토리지에 직접 쓰는 것이 아니라 메시지 큐와 메시지 브로커 등의 중계 시스템에 전송할 수 있다. 이 경우 기록된 데이터는 일정한 간격으로 꺼내고 모아서 함께 분산 스토리지에 저장한다.

#### 웹 브라우저에서의 메시지 배송

자체 개발한 웹 어플리케이션에서는 서버 웹 서버 안에서 메시지를 만들어 배송한다. 이때는 Fluentd나 Logstash와 같은 서버 상주형 로그 수집 소프트웨어가 자주 사용된다.

아니면 자바스크립트를 이용하여 웹 브라우저에서 직접 메시지를 보내는 경우도 있다. 이것은 웹 이벤트 추적이라고 한다. 수집된 데이터는 그대로 다른 서버로 전송되거나 API 경유로 함께 취득해 그것을 분산 스토리지에 저장함으로써 다른 데이터와 조합한 분석이 가능해진다.

<img src="https://drive.google.com/uc?export=view&id=1WwaOHineZrT8RqTb2XJzlWqD2euzbE5W">

#### 모바일 앱으로부터의 메시지 배송

모바일 앱은 HTTP 프로토콜을 사용하는 클라이언트이기 때문에 웹 브라우저와 동일하다. 또한 서버를 직접 마련하는 것이 아니라 MBaas라는 백엔드의 각종 서비스를 이용할 수도 있다.

아니면 모바일 앱에 톡화된 엑세스 해석 서비스를 통해 이벤트 데이터를 수집한다. 이 경우 서비스에서 제공되는 모바일 용의 SDK를 사용하여 메시지를 보낸다.

<img src="https://drive.google.com/uc?export=view&id=1HVBld5cVBZGFwTN8dsuhQssGCa0WFxdp">

#### 디바이스로부터의 메시지 배송

아직까지 디바이스로부터 메시지 전달은 표준이라고 할 만한 것 없이 많은 규격이 난립하고 있다. 그 중 MQTT는 TCP/IP를 사용하여 데이터를 전송하는 프로토콜의 하나이며, 일반적으로 Pub(전달)/Sub(구독) 형 메시지 배송의 구조를 가진다. 주로 채팅 시스템이나 메시징 앱 또는 푸시 알림 등의 시스템에서 자주 사용되는 기술이다.

MQTT에서는 관리자에 의해 토픽이 만들어진다. 이는 대화방 같은 것으로, 그 토픽을 구독하면 메시지가 도착하고, 그 토픽을 전달하면 구독 중인 모든 클라이언트에 보내진다.

<img src="https://drive.google.com/uc?export=view&id=1FnOe3FqdKQOgwRg2-Kbx7UYczTcdwucB">

#### 메시지 배송의 공통화

메시지 배송 방식은 어디에서 데이터를 수집하느냐에 따라 전혀 다르다. 여기서는 메시지가 처음 생성되는 기기를 클라이언트, 해당 메시지를 받는 서버를 프론트 엔드라고 한다. 프런트 엔드의 역할은 클라이언트와의 통시 프로토콜을 제대로 구현하는 것이다.

## 4.3 매시지 배송의 트레이드 오프: 성능X신뢰성

클라이언트의 수가 많아지면 스트리밍 형의 메시지 배송의 성능과 신뢰성을 둘 다 만족하기는 어렵게 된다.

### 메시지 브로커

대량의 메시지를 안정정으로 받기 위해서 빅데이터 메시지 시스템에서는 데이터를 일시적으로 축적하는 중산층이 설치되는데, 이를 메시지 브로커라고 한다.

<img src="https://drive.google.com/uc?export=view&id=1Sy8aMuH5-B6q6dUyxzc9ghkLeyMMpKaL">

빅데이터를 위한 분산형 메시지 브로커는 오픈 소스의 경우는 Apache Kafka, 클라우드 서비스라면 Amazon Kinesis 등이 유명하다.

#### 푸시 형과 풀 형

송신 측의 제어로 데이터를 보내는 방식을 푸시형이라고 하고, 수신 측의 주도로 데이터를 가져오는 것을 풀형이라고 한다.

메시지 브로커에 데이터를 푸시하는 것을 생산자(producer), 풀하는 것을 소비자(consumer)라고 한다. 메시지 브로커는 높은 빈도로 데이터를 쓰는 것에 최적화되어 있고, 뛰어난 확장성을 구현하고 있어서 푸시형의 메시지 배송은 모두 메시지 브로커에 집중시키고 거기에서 일정한 빈도로 꺼낸 데이터를 분산 스토리지에 기록하여 성능 문제를 피할 수 있다.

#### 메시지 라우팅

메시지 브로커에 써넣은 데이터는 복수의 다른 소비자에서 읽어 들일 수 있다. 이를 통해 메시지가 복사되어 데이터를 여러 경로로 분기시킬 수 있다. 이것을 메시지 라우팅이라고 한다. 예를 들어, 메시지 일부를 실시간 장애 감지를 사용하면서 같은 메시지를 장기적인 데이터 분석을 위한 분산 스토리지에 저장하는 것도 가능하다.

### 메시지 배송을 확실하게 실시하는 것은 어렵다. 

성능 문제 외에도 피할 수 없는 것이 신뢰성 문제이다. 이는 다음 중 하나를 보장하도록 설계하여 처리한다. 

- at most once

무슨 일이 일어나도 절대로 메시지를 다시 보내지 않는다. 그러나 도중에 전송에 실패해서 사라질 가능성이 있다. 

- exactly once 

메시지는 손실되거나 중복 없이 한 번만 전달된다. 메시지의 송/수신 측 모두 서로의 정보를 코디네이터에게 전달함으로써 문제가 발생한 경우에는 코디네이터의 지시에 따라 그것을 해결한다. 

하지만 이 또한 코디네이터가 문제가 생길 수도 있고, 시간이 너무 소요된다는 단점이 존재한다.

- at least once

메시지는 확실하게 전달된다. 단, 같은 것이 여러 번 전달될 가능성이 있다. 중복이 발생하지만, 모든 TCP 패킷에서는 그것을 식별하는 시퀀스 번호가 포함되어 있으며, 그것을 이용하여 중복 제거가 이루어진다. 

대부분의 메시지 배송 시스템은 이를 보장하는 한편, 중복 제거는 이용자에게 맡기고 있어 TCP/IP처럼 자동으로 중복을 제거해주지 않는다. 

### 중복 제거는 높은 비용의 오퍼레이션

